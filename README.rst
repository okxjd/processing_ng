=============
processing NG
=============

ver 3.9.1

Общие слова
-----------

Комбайн "все-в-одном", чтобы не поддерживать несколько разных модулей:
    - выгрузки Oracle > XLSX
    - обработка XLSX (склейка, сцепка по колонке, ...)
    - что-то еще по мере необходимости.


Сборка
------

Для сборки нужно запустить generate_executable.bat

Сборка EXE производится с помощью py2exe на Python 3.4.3 (потому что часть важных
сторонних модулей пока еще не работает на Python 3.5, в т.ч. не работает и py2exe).

Дополнительно скриптом prep.py формируются вспомогательные BAT-файлы.

Сборка тестировалась на Win7 x32.


Использование
-------------

::

    processing_ng --action <ACTION> --type <TYPE> --section <SECTION> [--db <DB ALIAS>] [--write_count] [--save_filenames] [--save_empty] [--use_src_subfolders] [--log] [--config <config file>]

    processing_ng -a <ACTION> -t <TYPE> -s <SECTION> [--db <DB ALIAS>] [--write_count] [--save_filenames] [--save_empty] [-u] [--log] [--config <config file>]

    processing_ng -v
    
    processing_ng -h

Параметры:

    :-h, --help: справка
    
    :-v, --version: информация о версии

    :--action, -a: основное действие
        
        - :unload: выгрузка из базы в файлы XLSX
        
        - :xlsx: обработка XLSX-файлов
        
        - :sql: формирование SQL-скриптов
        
        - :conv: конвертер форматов файлов
        
        - :send_files: копирование файлов или каталогов
    
    :--type, -t: уточнение основного действия
    
        - :simple: (unload) Обычная выгрузка по скриптам из папки, указанной в конфиге
        
        - :parametric: (unload) Выгрузка по скриптам с подстановкой параметров для LIKE
            
            Тип параметра задается в конфиге: param = block / district / ten
            В скриптах должен быть указан шаблон: o.cad_num like :kn||'%'
        
        - :allpvd: (unload) Выгрузка списка скриптов по всем серверам, указанным в конфиге с типом "pvd"
        
        - :by_xlsx_col: (unload) - особый случай. Здесь --section указывает на параметр в секции [UNLOAD_ACTIONS_LIST]
        
        - :local: (send_files) Копирует файлы из одного места в другое. Хитровыдуманно.
            
            Только локальные и сетевые диски. Сетевые диски *уже* должны быть подключены.
            При совпадении имен файлов в источнике и назначении - добавляет к имени
            файла источника суффикс на основе локального системного времени.
            
        - :ftp: (send_files) Копирует файлы из одного места в другое. Хитровыдуманно.
        
            Локальные и сетевые диски >> сервер FTP.
            Хост и кодировка - из конфига, но login/pass зашиты в программу.
            При совпадении имен файлов в источнике и назначении - добавляет к имени
            файла источника суффикс на основе локального системного времени.
        
        - :join: (xlsx) Склейка нескольких XLSX файлов в один
        
        - :split_rowcount: (xlsx) Разделить XLSX-файлы на части, размер частей - из конфига
        
        - :split_mask: (xlsx) Разделить XLSX-файлы на части по маске из конфига
        
        - :compare: (xlsx) Сопоставление XLSX-файлов. Вся дополнительная инфа - из конфига
        
        - :tpl_date_in_filename: (sql) SQL по шаблону №1
        
            Параметры - даты начала и конца периода из конфига, период включается в имя файла.
            
            В скриптах должны быть указаны шаблоны: to_date('{dstart}', '{dformat}') и to_date('{dstop}', '{dformat}')
        
        - :tpl_date: (sql) SQL по шаблону №2
        
            То же, что №1, но период **НЕ** включается в имя файла
        
        - :tpl_raion: (sql) SQL по шаблону №3
        
            Параметры зашиты в прогу - "по районам". В скриптах должен быть указан шаблон:
            
                o.cad_num like '{0}%'
        
        - :list: (sql) SQL по шаблону №4
        
            Параметр - список из csv, СКРИПТЫ БУДУТ НАЗВАНЫ ПО НАЗВАНИЮ CSV !!!
            
            В скриптах должен быть указан шаблон:
            
                o.cad_num in({0}) или req.request_number in({0}) или т.п.
        
        - :xlsx2xls: (conv) Конвертировать XLSX в XLS (из нового формата в старый)
        
    :--section, -s: секция в конфиге, содержащая все остальные необходимые параметры

    :--db: Имя базы данных, как оно указано в конфиге
        
    :--save_empty: записывать пустой файл выгрузки, если запрос вернул 0 строк
    
        работает только для "--action unload"
    
    :--write_count: добавлять количество записанных строк к имени файла
    
        работает только для "--action unload", "--action xlsx --type join" и "--action conv --type xlsx2xls"
        
    :--save_filenames: сохранять имена записанных файлов в файл, указанный в saved_filenames
        
        работает для всех --action, кроме send_files
        
    :--use_src_subfolders, -u: использовать часть имени каталога-источника (без верхнего уровня)
        
        в имени каталога-приемника (как завершающую часть).
        Пример: источник aaa\bbb\ccc, приемник zzz\xxx.
        Результирующий путь с ключом: zzz\xxx\bbb\ccc.
        Без ключа: zzz\xxx.
        
        Работает только для "--action unload".
        
    :--log: записывать логи

    :--config: указать другой файл конфига
    

Примеры
-------

::

    processing_ng -a unload -t simple -s UNLOAD --save_filenames
    processing_ng -a unload -t simple -s UNLOAD --save_empty --config "cfg/config.conf" -u
    processing_ng -a unload -t parametric -s UNLOAD --save_empty --write_count
    processing_ng -a unload -t allpvd -s UNLOAD --write_count --log --use_src_subfolders
    processing_ng -a xlsx -t join -s JOIN --config "cfg.conf"


Если программа не работает
--------------------------

Обычно программа запускается с правами текущего пользователя, поэтому, перед тем как ругаться,
проверьте права Вашего пользователя на доступ к файловой системе, сети и базе данных.

Если все хорошо, но по прежнему ничего не работает:
    - в Win7 - попробовать запускать от имени Администратора;
    - если установлен InstantClient (правильно установлен!) - удалить из каталога с программой файл OCI.dll;
    - карма?
    - у меня варианты кончились.
